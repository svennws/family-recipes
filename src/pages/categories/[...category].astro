---
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import CardGrid from '../../components/CardGrid.astro';
import CategoryGrid from '../../components/CategoryGrid.astro';
import { SITE_TITLE } from '../../consts';
import { getCollection } from 'astro:content';
import type { RecipeData } from '../../content/config';
import {
	buildCategoryIndex,
	formatCategoryTitle,
	getChildCategories
} from '../../utils/categories';

type RecipeListItem = RecipeData & { slug: string };

export async function getStaticPaths() {
	const entries = await getCollection('recipes');
	const categoryIndex = buildCategoryIndex(entries);
	const recipesByCategory = new Map<string, RecipeListItem[]>();

	for (const entry of entries) {
		const segments = entry.id.split('/');
		if (segments.length < 2) {
			continue;
		}

		const slug = segments.at(-1)!;
		const categorySegments = segments.slice(0, -1);

		for (let depth = 1; depth <= categorySegments.length; depth += 1) {
			const categoryKey = categorySegments.slice(0, depth).join('/');
			const current = recipesByCategory.get(categoryKey) ?? [];

			current.push({
				slug,
				...entry.data
			});

			recipesByCategory.set(categoryKey, current);
		}
	}

	return Array.from(recipesByCategory.entries()).map(([categoryKey, recipeList]) => {
		const subcategories = getChildCategories(categoryIndex, categoryKey).map((category) => ({
			label: category.label,
			href: `/categories/${category.segments.join('/')}`,
			count: category.count,
			title: category.title
		}));

		return {
			params: { category: categoryKey },
			props: {
				categorySegments: categoryKey.split('/'),
				recipes: recipeList.sort((a, b) => a.title.localeCompare(b.title)),
				subcategories
			}
		};
	});
}

const { categorySegments, recipes, subcategories } = Astro.props as {
	categorySegments: string[];
	recipes: RecipeListItem[];
	subcategories: {
		label: string;
		href: string;
		count: number;
		title: string;
	}[];
};

const categoryTitle = formatCategoryTitle(categorySegments);
---

<html lang="en">
	<head>
		<BaseHead title={`${categoryTitle} · ${SITE_TITLE}`} description={`Oppskrifter i kategorien ${categoryTitle}.`} />
		<style>
			main {
				width: 960px;
			}
			h1 {
				text-align: center;
				margin: 0.5em;
			}
			hr {
				margin: 1.5em;
			}
			.breadcrumb {
				margin: 0 0 1rem;
				text-align: center;
				color: rgb(var(--gray));
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<section>
				<p class="breadcrumb">{categoryTitle}</p>
			</section>
			{subcategories.length > 0 && (
				<section>
					<h1>Kategorier under {categoryTitle}</h1>
					<CategoryGrid categories={subcategories} />
				</section>
			)}
			<section>
				<h1>Oppskrifter i {categoryTitle}</h1>
				<CardGrid>
					{recipes.map((recipe) => (
						<li class="card-grid__item">
							<a class="card-grid__link" href={`/recipes/${recipe.slug}`}>
								<h4 class="card-grid__title">{recipe.title}</h4>
								<p class="card-grid__meta">{recipe.description}</p>
							</a>
						</li>
					))}
				</CardGrid>
			</section>
		</main>
		<Footer />
	</body>
</html>


